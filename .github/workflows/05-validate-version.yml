name: 05 - Validate Version

on:
  pull_request:
    branches: [ master ]
    paths:
      - 'pubspec.yaml'
  push:
    branches:
      - 'release/**'
      - 'hotfix/**'

jobs:
  validate-version:
    name: Validate version format and consistency
    runs-on: ubuntu-latest
    timeout-minutes: 5
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # 태그 정보를 가져오기 위해
      
      - name: Get version from pubspec.yaml
        id: version
        run: |
          VERSION=$(grep '^version:' pubspec.yaml | cut -d' ' -f2 | cut -d'+' -f1)
          BUILD=$(grep '^version:' pubspec.yaml | cut -d' ' -f2 | cut -d'+' -f2)
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "BUILD=$BUILD" >> $GITHUB_OUTPUT
          echo "Full version: $VERSION+$BUILD"
      
      - name: Validate version format
        run: |
          VERSION="${{ steps.version.outputs.VERSION }}"
          if ! echo "$VERSION" | grep -qE '^[0-9]+\.[0-9]+\.[0-9]+$'; then
            echo "❌ Invalid version format: $VERSION"
            echo "Expected format: MAJOR.MINOR.PATCH (e.g., 1.1.0)"
            exit 1
          fi
          echo "✅ Version format is valid: $VERSION"
      
      - name: Validate build number
        run: |
          BUILD="${{ steps.version.outputs.BUILD }}"
          if ! echo "$BUILD" | grep -qE '^[0-9]+$'; then
            echo "❌ Invalid build number: $BUILD"
            echo "Expected format: positive integer"
            exit 1
          fi
          echo "✅ Build number is valid: $BUILD"
      
      - name: Check if branch name matches version (for release/hotfix)
        if: startsWith(github.ref, 'refs/heads/release/') || startsWith(github.ref, 'refs/heads/hotfix/')
        run: |
          BRANCH_VERSION=$(echo ${{ github.ref }} | sed 's/refs\/heads\/release\/v//' | sed 's/refs\/heads\/hotfix\/v//')
          PUBSPEC_VERSION="${{ steps.version.outputs.VERSION }}"
          
          if [ "$BRANCH_VERSION" != "$PUBSPEC_VERSION" ]; then
            echo "❌ Version mismatch!"
            echo "Branch version: $BRANCH_VERSION"
            echo "pubspec.yaml version: $PUBSPEC_VERSION"
            echo "Please update pubspec.yaml to match the branch version"
            exit 1
          fi
          echo "✅ Branch version matches pubspec.yaml: $PUBSPEC_VERSION"
      
      - name: Check if tag already exists
        run: |
          VERSION="${{ steps.version.outputs.VERSION }}"
          TAG="v$VERSION"
          
          if git rev-parse "$TAG" >/dev/null 2>&1; then
            echo "⚠️  Tag $TAG already exists!"
            echo "If this is a rollback or hotfix, this is expected."
            echo "Otherwise, please use a new version number."
            # 주석 해제하면 중복 태그 방지
            # exit 1
          else
            echo "✅ Tag $TAG does not exist (OK)"
          fi

